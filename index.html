<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë² ì´ìŠ¤ìº í”„ ìˆ˜ë¦¬</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Press+Start+2P&display=swap');

        body {
            background-color: #1a1a1a;
            color: #eee;
            font-family: 'Black Han Sans', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        .main-container {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        h1 { text-shadow: 2px 2px 0px #8b0000; margin-bottom: 5px; font-size: 1.8rem; text-align: center;}
        p { color: #aaa; font-size: 0.8rem; margin-bottom: 20px; text-align: center; }

        #game-area {
            position: relative;
            display: flex;
            gap: 20px;
            background: #2b2b2b;
            padding: 20px;
            border: 4px solid #555;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        #fishing-bar-bg {
            width: 50px;
            height: 350px;
            background-color: #111;
            border: 2px solid #444;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }

        #target-zone {
            width: 100%;
            height: 80px; 
            background-color: rgba(50, 205, 50, 0.5);
            position: absolute;
            bottom: 50px; 
            left: 0;
            border-top: 2px solid #32cd32;
            border-bottom: 2px solid #32cd32;
        }

        #player-bar {
            width: 36px;
            height: 40px;
            background-color: #ffcc00;
            position: absolute;
            bottom: 150px; 
            left: 7px;
            border-radius: 5px;
            box-shadow: 0 0 5px #ffcc00;
            transition: background-color 0.1s; 
        }

        #overlay-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 20;
            flex-direction: column;
            text-align: center;
            pointer-events: none; 
        }
        
        #countdown-text {
            font-family: 'Press Start 2P', cursive;
            font-size: 4rem;
            color: #ffcc00;
            text-shadow: 4px 4px 0 #8b0000;
        }

        #time-container {
            width: 20px;
            height: 350px;
            background-color: #333;
            border: 1px solid #555;
            position: relative;
            display: flex;
            align-items: flex-end;
        }

        #time-fill {
            width: 100%; height: 100%; 
            background: linear-gradient(to top, #00bfff, #1e90ff);
            transition: height 0.1s linear;
        }
        #time-label {
            position: absolute; top: -25px; left: -15px; width: 50px;
            text-align: center; font-size: 0.7rem; color: #1e90ff;
        }
        #time-text {
            position: absolute; bottom: 5px; left: 0; width: 100%;
            text-align: center; font-size: 0.6rem; color: #fff; font-weight: bold;
        }

        .info-panel {
            width: 240px; /* ì¡°ê¸ˆ ë” ë„“ê²Œ */
            background: #222; padding: 15px; border-radius: 8px; border: 1px solid #444;
            display: flex; flex-direction: column; gap: 15px;
        }
        .info-box { text-align: center; }
        .score-display {
            font-family: 'Press Start 2P', cursive; color: #00ff00; font-size: 1.4rem; margin: 10px 0; text-shadow: 0 0 5px #006400;
        }
        .rank-list { list-style: none; padding: 0; margin: 0; text-align: left; font-size: 0.8rem; color: #ccc; }
        .rank-list li { margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 4px; display: flex; justify-content: space-between; }
        .rank-score { color: #ffcc00; font-family: 'Press Start 2P', cursive; font-size: 0.7rem;}
        input[type="text"] { width: 90%; padding: 8px; background: #333; border: 1px solid #555; color: white; text-align: center; font-family: 'Black Han Sans', sans-serif; margin-bottom: 5px; }
        #status-msg { margin-top: 15px; font-size: 1.1rem; color: #888; min-height: 24px; text-align: center; }
        
        /* [ì¶”ê°€] ì „ì²´ ëª©í‘œ ë°” ìŠ¤íƒ€ì¼ */
        .goal-container {
            margin-top: 10px;
            text-align: left;
        }
        .goal-bar-bg {
            width: 100%; height: 12px; background: #444; border-radius: 6px; overflow: hidden; margin-top: 5px;
        }
        .goal-bar-fill {
            width: 0%; height: 100%; background: linear-gradient(to right, #ff4444, #ffcc00);
            transition: width 1s ease-out;
        }
        .goal-text { font-size: 0.7rem; color: #aaa; display: flex; justify-content: space-between; margin-top: 3px; }
        .total-val { color: #ffcc00; font-family: 'Press Start 2P'; font-size: 0.7rem; }

        .controls { margin-top: 20px; display: flex; gap: 10px; }
        .btn {
            padding: 12px 20px; color: white; border: none; border-radius: 4px; cursor: pointer;
            font-family: inherit; font-size: 1rem; box-shadow: 0 4px 0 rgba(0,0,0,0.5); pointer-events: auto;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.5); }
        .btn-start { background: #8b0000; }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; margin-top: 0; background: #555; }
        .btn-reset { background: #333; color: #666; font-size: 0.7rem; padding: 3px 8px; margin-top: 5px; border: 1px solid #444; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(100%); }

    </style>
</head>
<body>

    <h1>ë² ì´ìŠ¤ìº í”„ ìˆ˜ë¦¬</h1>
    <p>30ì´ˆ ë™ì•ˆ ì§‘ì¤‘í•´ì„œ ìµœëŒ€í•œ ë§ì€ ì ìˆ˜ë¥¼ íšë“í•˜ì„¸ìš”!</p>

    <div class="main-container">
        <div id="game-area">
            <div id="fishing-bar-bg">
                <div id="target-zone"></div>
                <div id="player-bar"></div>
            </div>
            <div id="time-container">
                <div id="time-label">ë‚¨ì€ì‹œê°„</div>
                <div id="time-fill"></div>
                <div id="time-text">30</div>
            </div>
            
            <div id="overlay-screen">
                <div id="countdown-text">READY</div>
                <button id="btn-restart" class="btn btn-start" style="display:none; margin-top:20px;" onclick="startSequence()">ë‹¤ì‹œ ë„ì „</button>
            </div>
        </div>

        <div class="info-panel">
            <div class="info-box">
                <div style="font-size: 0.9rem; color:#aaa;">í˜„ì¬ ì ìˆ˜</div>
                <div id="current-score" class="score-display">0</div>
                <div style="font-size: 0.8rem; color:#aaa; margin-top:15px;">ìµœê³  ê¸°ë¡ (High Score)</div>
                <div id="best-score" style="color:#ffcc00; font-family:'Press Start 2P'; margin-top:5px;">0</div>
            </div>
            
            <hr style="width:100%; border:0; border-top:1px solid #444;">
            
            <div class="info-box">
                <input type="text" id="username-input" placeholder="ì´ë¦„ ì…ë ¥" maxlength="8">
                <button class="btn btn-small" onclick="updateName()">ì´ë¦„ ì €ì¥</button>
            </div>
            
            <div class="info-box">
                <div style="font-size: 0.8rem; color:#aaa; margin-bottom:10px;">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ (Top 5)</div>
                <ul id="leaderboard" class="rank-list"><li>ë¡œë”© ì¤‘...</li></ul>
                <button class="btn btn-small" style="background:#444; margin-top:10px;" onclick="loadLeaderboard()">ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <hr style="width:100%; border:0; border-top:1px solid #444;">

            <div class="info-box">
                <div style="font-size: 0.85rem; color:#aaa; margin-bottom:5px;">ğŸŒ ì „ì²´ ìƒì¡´ì ê¸°ì—¬ë„</div>
                <div class="total-val" id="global-score-text">0 / 35000</div>
                <div class="goal-container">
                    <div class="goal-bar-bg">
                    
                        <div id="global-progress" class="goal-bar-fill"></div>
                    </div>
                    <div class="goal-text">
                        <span>í˜„ì¬</span>
                        <span>ëª©í‘œ: 3ë§Œ5ì²œ </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="status-msg">ì¤€ë¹„ë¨</div>

    <div class="controls">
        <button id="btn-main-start" class="btn btn-start" onclick="startSequence()">ìˆ˜ë¦¬ ì‹œì‘</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2zLCI08iXD5eV-pC7Zav9SodGwNyHsxE",
            authDomain: "basecamp-1254b.firebaseapp.com",
            projectId: "basecamp-1254b",
            storageBucket: "basecamp-1254b.firebasestorage.app",
            messagingSenderId: "587183782376",
            appId: "1:587183782376:web:16cbbbface1cf8f0d18c5d",
            measurementId: "G-H5T9YJZ21T"
        };

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase ì—°ê²° ì„±ê³µ");
        } catch(e) {
            console.error("Firebase ì—°ê²° ì˜¤ë¥˜:", e);
            document.getElementById('status-msg').innerText = "DB ì—°ê²° ì‹¤íŒ¨";
        }

        let userId = localStorage.getItem('cs_survivor_id');
        let userName = localStorage.getItem('cs_survivor_name') || "ìƒì¡´ì_" + Math.floor(Math.random()*1000);

        if (!userId) {
            userId = 'user_' + Date.now();
            localStorage.setItem('cs_survivor_id', userId);
        }
        document.getElementById('username-input').value = userName;

        async function loadUserData() {
            if(!db) return;
            try {
                const docRef = doc(db, "scores_30s", userId); 
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('best-score').innerText = data.score || 0;
                    if(data.name) {
                        userName = data.name;
                        document.getElementById('username-input').value = userName;
                        localStorage.setItem('cs_survivor_name', userName);
                    }
                }
                loadLeaderboard();
                calculateGlobalTotal(); // [ì¶”ê°€] ì „ì²´ í•©ê³„ ê³„ì‚°
            } catch (e) { console.error(e); }
        }

        window.updateName = async () => {
            if(!db) return alert("DB ì—°ê²° ì•ˆë¨");
            const newName = document.getElementById('username-input').value;
            if(!newName) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");
            userName = newName;
            localStorage.setItem('cs_survivor_name', userName);
            alert("ì´ë¦„ ì €ì¥ ì™„ë£Œ (ë‹¤ìŒ ê²Œì„ ì¢…ë£Œ ì‹œ ë°˜ì˜)");
        }

        window.resetUserIdentity = () => {
            if(confirm("ê¸°ë¡ì„ ë‚¨ê²¨ë‘ê³  ìƒˆ ì´ë¦„ìœ¼ë¡œ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆê¹Œ?")) {
                localStorage.removeItem('cs_survivor_id');
                localStorage.removeItem('cs_survivor_name');
                location.reload();
            }
        }

        window.loadLeaderboard = async () => {
            if(!db) return;
            const list = document.getElementById('leaderboard');
            list.innerHTML = "<li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>";
            try {
                const q = query(collection(db, "scores_30s"), orderBy("score", "desc"), limit(5));
                const querySnapshot = await getDocs(q);
                list.innerHTML = "";
                
                if (querySnapshot.empty) {
                    list.innerHTML = "<li>ê¸°ë¡ ì—†ìŒ</li>";
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const d = doc.data();
                    const safeName = d.name ? (d.name.length > 6 ? d.name.substring(0,6)+".." : d.name) : "ìµëª…";
                    const li = document.createElement("li");
                    li.innerHTML = `<span>${safeName}</span> <span class="rank-score">${d.score}</span>`;
                    list.appendChild(li);
                });
            } catch (e) { 
                console.error(e); 
                list.innerHTML = "<li>ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨</li>";
            }
        }

        // [ì¶”ê°€ëœ ê¸°ëŠ¥] ì „ì²´ ì ìˆ˜ í•©ê³„ ê³„ì‚° í•¨ìˆ˜
        async function calculateGlobalTotal() {
            if(!db) return;
            try {
                const q = query(collection(db, "scores_30s"));
                const querySnapshot = await getDocs(q);
                let total = 0;
                
                querySnapshot.forEach((doc) => {
                    total += (doc.data().score || 0);
                });


                // ì§€ê¸ˆì€ ë³´ë„ˆìŠ¤ ì—†ì´ ì‹¤ì œ ì ìˆ˜ë§Œ í‘œì‹œ
                total += 1000;

                
                // UI ì—…ë°ì´íŠ¸
                const goal = 35000;
                document.getElementById('global-score-text').innerText = `${total.toLocaleString()} / ${goal.toLocaleString()}`;
                
                let percent = (total / goal) * 100;
                if(percent > 100) percent = 100;
                document.getElementById('global-progress').style.width = percent + "%";

            } catch(e) {
                console.error("í•©ê³„ ê³„ì‚° ì‹¤íŒ¨:", e);
            }
        }

        window.saveScore = async (finalScore) => {
            if(!db) return;
            try {
                const docRef = doc(db, "scores_30s", userId);
                const docSnap = await getDoc(docRef);
                let currentHigh = 0;
                if(docSnap.exists()) currentHigh = docSnap.data().score || 0;

                if (finalScore > currentHigh) {
                    await setDoc(docRef, {
                        score: finalScore,
                        name: userName,
                        date: new Date().toISOString()
                    });
                    document.getElementById('best-score').innerText = finalScore;
                    document.getElementById('status-msg').innerText = "ğŸ‰ ì‹ ê¸°ë¡ ì €ì¥ë¨!";
                    loadLeaderboard();
                    calculateGlobalTotal(); // ì‹ ê¸°ë¡ ê°±ì‹  ì‹œ ì „ì²´ í•©ê³„ë„ ë‹¤ì‹œ ê³„ì‚°
                } else {
                    document.getElementById('status-msg').innerText = "ê²Œì„ ì¢…ë£Œ (ìµœê³  ê¸°ë¡: " + currentHigh + ")";
                    // ê¸°ë¡ ê°±ì‹  ì•ˆ í•´ë„ ì°¸ì—¬í–ˆìœ¼ë‹ˆ í•©ê³„ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ë°˜ì˜ ëŠë‚Œ ìœ„í•´)
                    calculateGlobalTotal();
                }
            } catch (e) { console.error(e); }
        }

        loadUserData();
    </script>

    <script>
        // ---------------------------------------------------------
        // ğŸ® ê²Œì„ ë¡œì§ (ìˆ˜ì •ì—†ìŒ)
        // ---------------------------------------------------------
        const playerBar = document.getElementById('player-bar');
        const targetZone = document.getElementById('target-zone');
        const timeFill = document.getElementById('time-fill');
        const timeText = document.getElementById('time-text');
        const statusMsg = document.getElementById('status-msg');
        const scoreDisplay = document.getElementById('current-score');
        
        const overlay = document.getElementById('overlay-screen');
        const countdownText = document.getElementById('countdown-text');
        const btnRestart = document.getElementById('btn-restart');
        const btnMainStart = document.getElementById('btn-main-start');

        const containerHeight = 350;
        const GAME_DURATION = 30; 

        const gravity = 0.2; 
        const lift = -0.4;   
        const bounce = -0.2;     

        let playerPos = 150; 
        let playerVelocity = 0; 
        
        let targetPos = 50;
        let targetSpeed = 1.2;
        let targetDirection = 1; 
        let targetChangeTimer = 0; 

        let isPlaying = false; 
        let isCountingDown = false;
        let isMouseDown = false;
        
        let currentScore = 0;
        let timeLeft = GAME_DURATION;
        let gameLoopId;

        function handlePress(e) { 
            if(e.type === 'keydown' && e.code !== 'Space') return;
            if(e.type === 'keydown') e.preventDefault(); 
            isMouseDown = true; 
        }
        function handleRelease(e) { 
            if(e.type === 'keyup' && e.code !== 'Space') return;
            isMouseDown = false; 
        }

        window.addEventListener('mousedown', handlePress);
        window.addEventListener('mouseup', handleRelease);
        window.addEventListener('touchstart', handlePress, {passive: false});
        window.addEventListener('touchend', handleRelease);
        window.addEventListener('keydown', handlePress);
        window.addEventListener('keyup', handleRelease);

        function startSequence() {
            if (isPlaying || isCountingDown) return;
            
            isCountingDown = true;
            
            overlay.style.display = 'flex';
            overlay.style.pointerEvents = 'none';
            btnRestart.style.display = 'none'; 
            btnMainStart.disabled = true;
            statusMsg.innerText = "ì¹´ìš´íŠ¸ë‹¤ìš´...";
            
            currentScore = 0;
            scoreDisplay.innerText = "0";
            timeLeft = GAME_DURATION;
            updateTimeUI();
            
            playerPos = 150;
            playerVelocity = 0;
            playerBar.style.bottom = playerPos + 'px';

            let count = 3;
            countdownText.innerText = count;
            countdownText.style.color = "#ffcc00";
            countdownText.style.fontSize = "4rem";
            
            let cdInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownText.innerText = count;
                } else if (count === 0) {
                    clearInterval(cdInterval);
                    countdownText.innerText = "GO!";
                    countdownText.style.color = "#ff4444";
                    
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        overlay.style.pointerEvents = 'auto';
                    }, 500);

                    startGame(); 
                }
            }, 1000);
        }

        function startGame() {
            isPlaying = true;
            isCountingDown = false;
            
            statusMsg.innerText = "ğŸ”¥ ì‘ì „ ê°œì‹œ!";
            statusMsg.style.color = "#eee";
            
            document.activeElement.blur();
            cancelAnimationFrame(gameLoopId);
            gameLoop();
        }

        function stopGame() {
            isPlaying = false;
            cancelAnimationFrame(gameLoopId);
            
            overlay.style.display = 'flex';
            overlay.style.pointerEvents = 'auto'; 
            countdownText.innerText = "TIME OVER";
            countdownText.style.color = "#fff";
            countdownText.style.fontSize = "2.5rem"; 
            
            btnRestart.style.display = 'inline-block';
            btnRestart.innerText = `ì ìˆ˜: ${Math.floor(currentScore)} (ë‹¤ì‹œí•˜ê¸°)`;
            
            statusMsg.innerText = "ê¸°ë¡ ì €ì¥ ì¤‘...";
            btnMainStart.disabled = false;

            if(window.saveScore) window.saveScore(Math.floor(currentScore));
        }

        function updateTimeUI() {
            let pct = (timeLeft / GAME_DURATION) * 100;
            timeFill.style.height = pct + '%';
            timeText.innerText = Math.ceil(timeLeft);
            
            if (timeLeft <= 5) timeFill.style.background = "#ff0000"; 
            else timeFill.style.background = "linear-gradient(to top, #00bfff, #1e90ff)";
        }

        function gameLoop() {
            if (!isPlaying) return;

            // ì‹œê°„
            timeLeft -= 0.016; 
            if (timeLeft <= 0) {
                timeLeft = 0;
                updateTimeUI();
                stopGame();
                return;
            }
            updateTimeUI();

            // ë¬¼ë¦¬
            if (isMouseDown) playerVelocity += lift; 
            playerVelocity += gravity; 
            playerPos -= playerVelocity; 

            // ë°”ë‹¥/ì²œì¥ ì¶©ëŒ
            if (playerPos < 0) {
                playerPos = 0;
                playerVelocity *= bounce; 
                if(Math.abs(playerVelocity) < 0.5) playerVelocity = 0; 
            }
            if (playerPos > containerHeight - 40) { 
                playerPos = containerHeight - 40;
                playerVelocity *= bounce; 
            }

            // íƒ€ê²Ÿ ì´ë™
            targetChangeTimer++;
            if (targetChangeTimer > 50) { 
                targetChangeTimer = 0;
                if (Math.random() > 0.6) targetDirection *= -1; 
                targetSpeed = Math.random() * 1.5 + 0.5; 
            }
            targetPos += targetSpeed * targetDirection;

            if (targetPos < 0) { targetPos = 0; targetDirection = 1; }
            if (targetPos > containerHeight - 80) { targetPos = containerHeight - 80; targetDirection = -1; }

            // íŒì •
            let playerCenter = playerPos + 20; 
            let targetBottom = targetPos;
            let targetTop = targetPos + 80;

            let isOverlap = playerCenter > targetBottom && playerCenter < targetTop;

            if (isOverlap) {
                playerBar.style.backgroundColor = "#ffcc00"; 
                currentScore += 1; 
            } else {
                playerBar.style.backgroundColor = "#777"; 
            }

            // ê·¸ë¦¬ê¸° (ì—¬ê¸°ê°€ ì•ˆë˜ë©´ ì•ˆì›€ì§ì„)
            playerBar.style.bottom = playerPos + 'px';
            targetZone.style.bottom = targetPos + 'px';

            scoreDisplay.innerText = Math.floor(currentScore);

            gameLoopId = requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
